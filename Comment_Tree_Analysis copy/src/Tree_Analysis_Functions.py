'''
Created on Nov 15, 2010

@author: johndoty
'''

import comment_thread_time_series_functions as time_series

THREAD = {
           "body": "Im ready for the attacks, but I myself am religious.  Not over-the-top \"everyone is going to hell if they don't beleive\" type, just a personal thing. \n\nI wanted to share my little side-of-the road story that happened to me just today:\n\nI'm driving back to my house down a long just-out-of-town road and i see this big guy (not FAT, but definitely not in-shape) walking down the same westbound side that I was.  He's obviously sweating his ass off (Heat index was around 105-110), was carrying a jug of which I assume was water and had a redish/burgundy towel draped around his neck.  I think to myself that it is apparent that this guy has had one hell of a walk since I did not see any broken-down cars the entire time i've been on this road, so i get to the next u-turn legal break in the median and head back his way\n\nI clear all my junk off the front seat so he would have a clutter free place to rest in my car's A/C (floorboard was a mess with miscelaneous 'havent cleaned out in over a month' type crap, but not much i could do while driving)  I get back to the nearest u-turn spot again and do so.  I pull over on the side of the road just behind the guy and tap the horn a couple times.  He looks back and I motion to my empty passenger seat.  He walks up to the passenger door as i roll the window down and I ask him if he needs a ride.  He says \"Man if I had run into you back at 295 (the hwy which was at least 10 miles back from where I was coming) I would, but im heading right up there where those signs are.\" he points to a couple roadsigns about 400ft ahead.  \n\nHe then thanks me for the offer and calls me \"brother\" (not any religious connotation involved, btw) and asks if I have a cigarette I could spare, so i gave him one, and pulled off back on my way.\n\nshit happens, and sometimes your too late.  \n\nMoral of the story: Be Excellent To Each Other, Regardless of Faith.",
           "subreddit_id": "t5_2qh2p",
           "name": "t1_c0vmuem",
           "created": 1280552049,
           "downs": 9,
           "author": "newnetmp3",
           "created_utc": 1280552049,
           "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;Im ready for the attacks, but I myself am religious.  Not over-the-top \"everyone is going to hell if they don't beleive\" type, just a personal thing.&lt;/p&gt;\n\n&lt;p&gt;I wanted to share my little side-of-the road story that happened to me just today:&lt;/p&gt;\n\n&lt;p&gt;I'm driving back to my house down a long just-out-of-town road and i see this big guy (not FAT, but definitely not in-shape) walking down the same westbound side that I was.  He's obviously sweating his ass off (Heat index was around 105-110), was carrying a jug of which I assume was water and had a redish/burgundy towel draped around his neck.  I think to myself that it is apparent that this guy has had one hell of a walk since I did not see any broken-down cars the entire time i've been on this road, so i get to the next u-turn legal break in the median and head back his way&lt;/p&gt;\n\n&lt;p&gt;I clear all my junk off the front seat so he would have a clutter free place to rest in my car's A/C (floorboard was a mess with miscelaneous 'havent cleaned out in over a month' type crap, but not much i could do while driving)  I get back to the nearest u-turn spot again and do so.  I pull over on the side of the road just behind the guy and tap the horn a couple times.  He looks back and I motion to my empty passenger seat.  He walks up to the passenger door as i roll the window down and I ask him if he needs a ride.  He says \"Man if I had run into you back at 295 (the hwy which was at least 10 miles back from where I was coming) I would, but im heading right up there where those signs are.\" he points to a couple roadsigns about 400ft ahead.&lt;/p&gt;\n\n&lt;p&gt;He then thanks me for the offer and calls me \"brother\" (not any religious connotation involved, btw) and asks if I have a cigarette I could spare, so i gave him one, and pulled off back on my way.&lt;/p&gt;\n\n&lt;p&gt;shit happens, and sometimes your too late.&lt;/p&gt;\n\n&lt;p&gt;Moral of the story: Be Excellent To Each Other, Regardless of Faith.&lt;/p&gt;&lt;/div&gt;",
           "levenshtein": "",
           "link_id": "t3_cvpyg",
           "parent_id": "t3_cvpyg",
           "likes": "",
           "replies": [
               {
                   "body": "I'm an atheist and I would've just raped him.",
                   "subreddit_id": "t5_2qh2p",
                   "name": "t1_c0vn0bi",
                   "created": 1280558095,
                   "downs": 6,
                   "author": "rape_master_flex",
                   "created_utc": 1280558095,
                   "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;I'm an atheist and I would've just raped him.&lt;/p&gt;&lt;/div&gt;",
                   "levenshtein": "",
                   "link_id": "t3_cvpyg",
                   "parent_id": "t1_c0vmuem",
                   "likes": "",
                   "replies": [
                       {
                           "body": "If that's what floats your boat.  I prefer to only rape females, If i had a choice in the matter.",
                           "subreddit_id": "t5_2qh2p",
                           "name": "t1_c0vn1zd",
                           "created": 1280560189,
                           "downs": 4,
                           "author": "newnetmp3",
                           "created_utc": 1280560189,
                           "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;If that's what floats your boat.  I prefer to only rape females, If i had a choice in the matter.&lt;/p&gt;&lt;/div&gt;",
                           "levenshtein": "",
                           "link_id": "t3_cvpyg",
                           "parent_id": "t1_c0vn0bi",
                           "likes": "",
                           "replies": [
                               {
                                   "body": "I don't like to discriminate. I'm equal opportunity. Except when it comes to Laplanders, I don't want my dick to smell like caribou for a month.",
                                   "subreddit_id": "t5_2qh2p",
                                   "name": "t1_c0vn7sd",
                                   "created": 1280569714,
                                   "downs": 2,
                                   "author": "rape_master_flex",
                                   "created_utc": 1280569714,
                                   "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;I don't like to discriminate. I'm equal opportunity. Except when it comes to Laplanders, I don't want my dick to smell like caribou for a month.&lt;/p&gt;&lt;/div&gt;",
                                   "levenshtein": "",
                                   "link_id": "t3_cvpyg",
                                   "parent_id": "t1_c0vn1zd",
                                   "likes": "",
                                   "replies": [
                                       {
                                           "body": "How about gingers?",
                                           "subreddit_id": "t5_2qh2p",
                                           "name": "t1_c0vo0zw",
                                           "created": 1280606740,
                                           "downs": 0,
                                           "author": "magusg",
                                           "created_utc": 1280606740,
                                           "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;How about gingers?&lt;/p&gt;&lt;/div&gt;",
                                           "levenshtein": "",
                                           "link_id": "t3_cvpyg",
                                           "parent_id": "t1_c0vn7sd",
                                           "likes": "",
                                           "replies": [
                                           ],
                                           "subreddit": "atheism",
                                           "ups": 2,
                                           "id": "c0vo0zw",
                                           "kind": "t1"
                                       }
                                   ],
                                   "subreddit": "atheism",
                                   "ups": 13,
                                   "id": "c0vn7sd",
                                   "kind": "t1"
                               },
                               {
                                   "body": "If the female offered up anal, you'd agree in a second. So technically, an ass is an ass, stop being so picky.",
                                   "subreddit_id": "t5_2qh2p",
                                   "name": "t1_c0vnl7z",
                                   "created": 1280592224,
                                   "downs": 2,
                                   "author": "fedja",
                                   "created_utc": 1280592224,
                                   "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;If the female offered up anal, you'd agree in a second. So technically, an ass is an ass, stop being so picky.&lt;/p&gt;&lt;/div&gt;",
                                   "levenshtein": "",
                                   "link_id": "t3_cvpyg",
                                   "parent_id": "t1_c0vn1zd",
                                   "likes": "",
                                   "replies": "",
                                   "subreddit": "atheism",
                                   "ups": 6,
                                   "id": "c0vnl7z",
                                   "kind": "t1"
                               }
                           ],
                           "subreddit": "atheism",
                           "ups": 7,
                           "id": "c0vn1zd",
                           "kind": "t1"
                       }
                   ],
                   "subreddit": "atheism",
                   "ups": 23,
                   "id": "c0vn0bi",
                   "kind": "t1"
               },
               {
                   "body": "I can't tell if you are trolling or not. I thought Christians don't smoke because it defiles their body as a temple?\n\nYou are also hanging out with us heathens down here in purgatory. Are you sure you aren't lost, *brother*?",
                   "subreddit_id": "t5_2qh2p",
                   "name": "t1_c0vmz7d",
                   "created": 1280556755,
                   "downs": 5,
                   "author": "breeze4",
                   "created_utc": 1280556755,
                   "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;I can't tell if you are trolling or not. I thought Christians don't smoke because it defiles their body as a temple?&lt;/p&gt;\n\n&lt;p&gt;You are also hanging out with us heathens down here in purgatory. Are you sure you aren't lost, &lt;em&gt;brother&lt;/em&gt;?&lt;/p&gt;&lt;/div&gt;",
                   "levenshtein": "",
                   "link_id": "t3_cvpyg",
                   "parent_id": "t1_c0vmuem",
                   "likes": "",
                   "replies": [
                       {
                           "body": "I dare not get into the concepts of what is and is not a sin with a bunch of atheists.. no offence, but i still claim the right to chose my battles. As far as being lost, *brother*, I have had my own doubts and troubles in my life. But they are mine. As are the decisions I have made.\n\nAs far as trolling: no.\n\nedit: I went the wrong direction with this post... wasn't trying to get into the \"sin\" category, merely trying to say that im not a \"Perfect\" Christian by any means.  Please excuse my previous, damn near trollish, statement.",
                           "subreddit_id": "t5_2qh2p",
                           "name": "t1_c0vn1vz",
                           "created": 1280560075,
                           "downs": 1,
                           "author": "newnetmp3",
                           "created_utc": 1280560075,
                           "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;I dare not get into the concepts of what is and is not a sin with a bunch of atheists.. no offence, but i still claim the right to chose my battles. As far as being lost, &lt;em&gt;brother&lt;/em&gt;, I have had my own doubts and troubles in my life. But they are mine. As are the decisions I have made.&lt;/p&gt;\n\n&lt;p&gt;As far as trolling: no.&lt;/p&gt;\n\n&lt;p&gt;edit: I went the wrong direction with this post... wasn't trying to get into the \"sin\" category, merely trying to say that im not a \"Perfect\" Christian by any means.  Please excuse my previous, damn near trollish, statement.&lt;/p&gt;&lt;/div&gt;",
                           "levenshtein": "",
                           "link_id": "t3_cvpyg",
                           "parent_id": "t1_c0vmz7d",
                           "likes": "",
                           "replies": [
                               {
                                   "body": "&gt; I dare not get into the concepts of what is and is not a sin with a bunch of atheists..\n\n\nA bit down the road and you might find yourself not only having that conversation, but you may even be on the 'wrong' side, so to speak.\n\n\nYou're in good company, whether you choose to discuss a specific concept or not. I myself welcome you, atheist or not. Many of us have been in your shoes.",
                                   "subreddit_id": "t5_2qh2p",
                                   "name": "t1_c0vno5a",
                                   "created": 1280595084,
                                   "downs": 0,
                                   "author": "abattle",
                                   "created_utc": 1280595084,
                                   "body_html": "&lt;div class=\"md\"&gt;&lt;blockquote&gt;&lt;p&gt;I dare not get into the concepts of what is and is not a sin with a bunch of atheists..&lt;/p&gt;&lt;/blockquote&gt;\n\n&lt;p&gt;A bit down the road and you might find yourself not only having that conversation, but you may even be on the 'wrong' side, so to speak.&lt;/p&gt;\n\n&lt;p&gt;You're in good company, whether you choose to discuss a specific concept or not. I myself welcome you, atheist or not. Many of us have been in your shoes.&lt;/p&gt;&lt;/div&gt;",
                                   "levenshtein": "",
                                   "link_id": "t3_cvpyg",
                                   "parent_id": "t1_c0vn1vz",
                                   "likes": "",
                                   "replies": "",
                                   "subreddit": "atheism",
                                   "ups": 2,
                                   "id": "c0vno5a",
                                   "kind": "t1"
                               },
                               {
                                   "body": "So you, like many Christians, only like discussing these topics with people who don't know any better? I like to call them \"soon to be Ex-Christians\". I've been there; I don't know how long you've been struggling with your faith, but you'll find the truth if you keep searching.\n\nEdit: Oops, just reloaded and saw your edit. That was pretty trollish. Well played.",
                                   "subreddit_id": "t5_2qh2p",
                                   "name": "t1_c0vn37c",
                                   "created": 1280561878,
                                   "downs": 2,
                                   "author": "breeze4",
                                   "created_utc": 1280561878,
                                   "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;So you, like many Christians, only like discussing these topics with people who don't know any better? I like to call them \"soon to be Ex-Christians\". I've been there; I don't know how long you've been struggling with your faith, but you'll find the truth if you keep searching.&lt;/p&gt;\n\n&lt;p&gt;Edit: Oops, just reloaded and saw your edit. That was pretty trollish. Well played.&lt;/p&gt;&lt;/div&gt;",
                                   "levenshtein": "",
                                   "link_id": "t3_cvpyg",
                                   "parent_id": "t1_c0vn1vz",
                                   "likes": "",
                                   "replies": [
                                   ],
                                   "subreddit": "atheism",
                                   "ups": 4,
                                   "id": "c0vn37c",
                                   "kind": "t1"
                               }
                           ],
                           "subreddit": "atheism",
                           "ups": 8,
                           "id": "c0vn1vz",
                           "kind": "t1"
                       }
                   ],
                   "subreddit": "atheism",
                   "ups": 7,
                   "id": "c0vmz7d",
                   "kind": "t1"
               },
               {
                   "body": "Thank you for posting. Please don't downvote. Excellent point made sir. ",
                   "subreddit_id": "t5_2qh2p",
                   "name": "t1_c0vmvc0",
                   "created": 1280552906,
                   "downs": 3,
                   "author": "geekweed",
                   "created_utc": 1280552906,
                   "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;Thank you for posting. Please don't downvote. Excellent point made sir.&lt;/p&gt;&lt;/div&gt;",
                   "levenshtein": "",
                   "link_id": "t3_cvpyg",
                   "parent_id": "t1_c0vmuem",
                   "likes": "",
                   "replies": "",
                   "subreddit": "atheism",
                   "ups": 5,
                   "id": "c0vmvc0",
                   "kind": "t1"
               }
           ],
           "subreddit": "atheism",
           "ups": 35,
           "id": "c0vmuem",
           "kind": "t1"
       }

THREAD2 = {
           "name": "t1_c0vmyts",
           "created": 1280556313,
           "author": "Measure76",
           "created_utc": 1280556313,
           "link_id": "t3_cvpyg",
           "parent_id": "t3_cvpyg",
           "replies": [
               {
                   "name": "t1_c0vn00u",
                   "created": 1280557757,            
                   "author": "missmonkey",
                   "created_utc": 1280557757,
                   "body_html": "&lt;div class=\"md\"&gt;&lt;p&gt;Ah, the old \"I'll pray for you! \" passive aggressive bullshit. It's how christians say \"FFFFFFFFUUUUUUUU!\"&lt;/p&gt;&lt;/div&gt;",             
                   "link_id": "t3_cvpyg",
                   "parent_id": "t1_c0vmyts",             
                   "replies": [
                   ],           
                   "id": "c0vn00u",           
               }
           ],
           "id": "c0vmyts",
       }


COMMENT_LIST = [THREAD, THREAD2]

THREAD3 = {"name": 't1_first',
           "replies": [
                       {
                        "name": 't1_fourth',
                        "replies": [
                                    {"name": 't1_fifth',
                                    "replies": [],
                                    "parent_id": 't1_fourth',
                                    "created_utc": 38,
                                    }
                                    ],
                        "parent_id" : 't1_first',
                        "created_utc": 12,
                        }

                       ],
           "parent_id": 't3_cvpyg',
           "created_utc": 11
           }
        


THREAD4 = {"name": 't1_second',
           "replies": [
                       {"name": 't1_sixth',
                        "replies": [],
                        "parent_id": 't1_second',
                        "created_utc": 28
                        }

                       ],
           "parent_id": 't3_cvpyg',
           "created_utc": 23,
           }

THREAD5 = {"name": 't1_third',
           "replies": [],
           "parent_id":'t3_cvpyg',
           "created_utc": 34,
           }

COMMENT_LIST2 = [THREAD3, THREAD4, THREAD5]

'''/////////////////////////////////
///
///    PROPERTIES TIME SERIES
///
/////////////////////////////////'''
def properties_time_series(comment_list):
    '''param: a list of comments in a thread organized from earliest to last
    records property values at each comment step
    returns a list of dictionaries containing those properties'''
    series = []
    tree = []
    for comment in comment_list:
         time_series.rebuild_tree_from_time_series(tree, comment)
         series.append(analyze_all_properties(tree))
    return series
      
      
'''/////////////////////////////////
///
///    RECORD ALL PROPERTIES
///
/////////////////////////////////'''
def analyze_all_properties(node_list):
    properties = {}
    properties['total_nodes_in_comments'] = total_nodes_in_comments(node_list)
    properties['average_max_depth'] = average_max_depth(node_list)
    properties['max_depth_tree'] = max_depth_tree(node_list)
    properties['average_branching_factor_of_branches'] = average_branching_factor_of_branches(node_list)
    properties['average_branching_factor_of_nodes'] = average_branching_factor_of_nodes(node_list)
    properties['number_stubs'] = number_stubs(node_list)
    properties['ratio_of_stubs'] = ratio_of_stubs(node_list)
    return properties


'''/////////////////////////////////
///
///    HELPER FUNCTIONS
///
/////////////////////////////////'''

def get_children(parent):
    '''
    returns the list of responses to the parent node if they exist
    else returns 'None'
    ''' 
    if "replies" in parent:
        #print("IN GET CHILDREN")
        #print(parent)
        return parent["replies"]
    else:
        return None
    

'''/////////////////////////////////
///
///    MAX DEPTH 
///
/////////////////////////////////'''

def average_max_depth(node_list):
    '''
    returns the average max depth of all comment threads
    associated with a particular post
    '''
    num_nodes = len(node_list)
    total_depths = 0
    for node in node_list:
        total_depths += max_depth_branch(node)
    if num_nodes == 0:
        return 0
    else:
        return float(total_depths)/num_nodes


def max_depth_branch(node):
    '''
    maximum depth of a particular comment branch
    '''
    children = get_children(node)
    if children == None or children == "" or children == []:
        return 1
    
    deepest = 0
    depth = 0
    for child in children:
        depth = max_depth_branch(child)
        if depth > deepest:
            deepest = depth
            
    deepest = deepest+1
    return deepest


def max_depth_tree(node_list):
    deepest = 0
    for branch in node_list:
        current = max_depth_branch(branch)
        if current > deepest:
            deepest = current
    return deepest
            


'''/////////////////////////////////
///
///    TOTAL NODES
///
/////////////////////////////////'''
def total_nodes_in_comments(node_list):
    '''
    returns the total number of nodes 
    from all comment threads associated with a particular post
    '''
    total = 0
    for node in node_list:
        total += total_nodes_in_branch(node)
    return total


def total_nodes_in_branch(node):
    '''
    returns the total number of nodes in a particular comment thread
    '''
    children = get_children(node)
    if children == None or children == "" or children == []:
        return 1
    
    total = 0
    for child in children:
        total += total_nodes_in_branch(child)
    
    total+=1
    return total


'''/////////////////////////////////
///
///    AVERAGE BRANCHING FACTOR
///
/////////////////////////////////'''
def average_branching_factor_of_branches(node_list):
    '''
    returns the average branching factor of all comment threads
    gives each thread equal weight
    might change this to ignore stub threads (threads with only 1 comment)
    '''
    num = len(node_list)
    sum_of_avg = 0
    for node in node_list:
        sum_of_avg += average_branching_factor(node)
    if num == 0:
        return 0
    else:
        return float(sum_of_avg)/num
        
        
def average_branching_factor_of_nodes(node_list):
    '''
    
    '''
    total_branches = 0
    total_nodes = 0
    for node in node_list:
        branches, nodes = rec_average_branching_factor(node)
        if branches == None or nodes == None:
            total_nodes += 1
        else:
            total_branches += branches
            total_nodes += nodes
    return float(total_branches)/total_nodes
        

def average_branching_factor(root):
    '''
    returns the average branching factor 
    of a single thread from the list ofcomment 
    '''
    total_branches, total_nodes = rec_average_branching_factor(root)
    '''if it's a stub, return branching factor of 0'''
    if total_branches == None or total_nodes == None:
        return 0
    
    return float(total_branches) / total_nodes
    

def rec_average_branching_factor(root):
    ''' 
    recursive function to determine the average branching factor
    of a comment thread
    returns total branches, total nodes
    '''
    children = get_children(root)
    if children == None or children == "" or children == []: 
        return (None, None)
    
    total_branches = len(children)
    total_non_terminal_nodes = 1
    for child in children:
        child_branches, child_nodes = rec_average_branching_factor(child)
        if child_branches != None and child_nodes != None:
            total_branches += child_branches
            total_non_terminal_nodes += child_nodes
    return total_branches, total_non_terminal_nodes


'''/////////////////////////////////
///
///    NUMBER OF STUB COMMENTS
///
/////////////////////////////////'''

def number_stubs(node_list):
    total = 0
    for node in node_list:
        children = get_children(node)
        if children == None or children == "" or children == []:
            total = total + 1
    return total

def ratio_of_stubs(node_list):
    total_stubs = number_stubs(node_list)
    total_nodes = total_nodes_in_comments(node_list)
    if total_nodes == 0:
        return 0
    else:
        return float(total_stubs)/total_nodes



'''/////////////////////////////////
///
///    MAIN
///
/////////////////////////////////'''

if __name__ == "__main__":
    print("RUNNING TEST SUITE")
    
    my_thread = time_series.create_comment_time_frame(COMMENT_LIST2)
    print "Length of my_thread is: %d" % len(my_thread)
    for item in my_thread:
        print time_series.utc_key_func(item)
    
    tree = []
    num = 0;
    for item in my_thread:
        time_series.rebuild_tree_from_time_series(tree, item)
        print "ITERATION NUMBER %d" % num
        print tree
        print '\n'
        num += 1
        
    if tree == COMMENT_LIST:
        print "created exact same thread"

    

    print COMMENT_LIST2
    print "\nTESTING ANALYSIS OF COMMENT_THREAD2"
    print "TOTAL NODES IN COMMENTS:           %d" % total_nodes_in_comments(COMMENT_LIST2)
    print "AVERAGE MAX DEPTH:                 %d" % average_max_depth(COMMENT_LIST2)
    print "MAXIMUM DEPTH:                     %d" % max_depth_tree(COMMENT_LIST2)
    print "AVERAGE BRANCHING FACTOR BRANCHES: %f" % average_branching_factor_of_branches(COMMENT_LIST2)
    print "AVERAGE BRANCHING FACTOR NODES:    %f" % average_branching_factor_of_nodes(COMMENT_LIST2)
    print "NUMBER OF STUBS:                   %d" % number_stubs(COMMENT_LIST2)
    print "STUB RATIO:                        %f" % ratio_of_stubs(COMMENT_LIST2)
    
    
    print "\nTESTING ALL PROPERTIES FUNCTION"
    properties = analyze_all_properties(COMMENT_LIST2)
    for key, item in properties.items():
        print "Key: %s, Item: %f" % (key, item)
    
    print "\nTESTING TIME SERIES PROPERTY ANALYSIS"
    series = time_series.create_comment_time_frame(COMMENT_LIST2)
    properties_series = properties_time_series(series)
    num = 0
    for record in properties_series:
        print "COMMENT NUMBER %d PROPERTIES:" % num
        print record
        num += 1
        
    
    